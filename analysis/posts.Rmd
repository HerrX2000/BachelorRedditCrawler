---
title: "RedditAnalysis"
author: "Frederik Mann"
date: "29 6 2021"
output:
  html_document: default
  pdf_document: default
---

```{r setup, echo=FALSE, cache=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#todo: fix width options
options(width = 100)
windows.options(width=30, height=10)
```

## Posts

```{r libs}
library(pacman)
p_load(RColorBrewer, # color pallets
       ggplot2, # reportable graphs
       cowplot, # arranges ggplot graphs nicely
       stargazer,
       MASS,
       DescTools,
       plyr) 
```

### Import data set
```{r import, cache=TRUE}
df_berlin <- read.csv("posts_berlin_2020.csv")
df_germany <- read.csv("posts_de_2020.csv")
df_europe <- read.csv("posts_europe_2020_partial.csv")
df <- rbind(df_berlin, df_germany, df_europe)
```

### Inspect
```{r inspect}
df$over_18 <- as.logical(df$over_18)
df$locked <- as.logical(df$locked)
df$is_video <- as.logical(df$is_video)
df$is_original_content <- as.logical(df$is_original_content)
df$stickied <- as.logical(df$stickied)
df$subreddit <- as.factor(df$subreddit)

str(df)
```

### Preprocess: Treat missing values, if applicable
```{r preprocess}
df$author_fullname[df$author_fullname == "NULL"] <- NA
df$author[df$author == ""] <- NA
df$selftext[df$selftext == "[deleted]"] <- NA
nrow(df)
df <-df[!duplicated(df$id), ]
nrow(df)

# Track down variables with missing values
sum(is.na(df))
colSums(is.na(df))

# Check the percentage of missing values in the data set
(nrow(df) - nrow(na.omit(df))) / nrow(df)


df$date <- as.Date(df$datetime)



to_interval <- function(anchor.date, future.date, interval.days){
  round(as.integer(future.date - anchor.date) / interval.days, 0)
}

df$interval <- to_interval(as.Date('2020-01-01'), 
                          df$date, 30 )

df$interval <- factor(df$interval)

df$month <- format(df$date, "%m")
df$month <- factor(df$month)

count(df[df$stickied == TRUE,])

df <- df[!(df$stickied == TRUE),]

str(df)
```

### Data Visualisation
```{r visualisation}
data.frame(table(df$month))

dfwi <- data.frame(table(df$interval))
dfwi


tbl <- with(df, table(subreddit, interval))
ggplot(as.data.frame(tbl), aes(factor(interval), Freq, fill = subreddit)) +     
  geom_col(position = 'dodge')



Gini(dfwi$Freq)

nrow(df)
df_with_acc <- na.omit(df)
nrow(df_with_acc)

#df_with_acc <- df_with_acc[df_with_acc$score > 10,]

 

df_subs <- data.frame(
                 interval=character(),
                 gini_post_dist=double(),
                 gini_score_dist=double(),
                 subreddit=factor(levels = levels(df_with_acc$subreddit)),
                 contributors = integer(),
                 total_posts = integer(),
                 turnover = double(),
                 stringsAsFactors=TRUE
                 )

for (subreddit in levels(df_with_acc$subreddit)){
  df_subreddit <- df_with_acc[df_with_acc$subreddit == subreddit, ]
  df_author_prev_interval <- NULL
  for (interval in unique(df_subreddit$interval)){
    df_7day <- df_subreddit[df_subreddit$interval == interval, ]
    
    df_author_posts <- count(df_7day, vars = "author")
    
    df_author_score <- aggregate(df_7day$score, by=list(author=df_7day$author), FUN=sum)
  
    
    df_author <- merge(df_author_posts, df_author_score, by="author")
    df_author$score_per_post <- df_author$x / df_author$freq
    df_author$perc_of_total_post <- df_author$freq / length(df_author)
    "
     To calculate the coefficient, we divided 
    the average difference in the number of comments posted by 
    each possible pair of users who contributed to a given sub-
    reddit during a given month by the number of UCs for that 
    month in that subreddit.
    (see ref paper)
    where xi = number of comments by UC in a given month in a 
    given subreddit and n = number of UCs in a given month in a 
    given subreddit.
    "
    gini_score_dist <- Gini(df_author$score_per_post)
    gini_post_dist <- Gini(df_author$freq)
    
    #todo: test if turnover is calculated correctly
    "
    Turnover  was  determined  by  comparing  a  list  of  
    UCs who contributed to discourse in a given subreddit dur-
    ing  a  given  month  to  a  list  of  UCs  who  contributed  to  dis-
    course in that same subreddit during the subsequent month. 
    Our  turnover  metric  is  an  expression  of  the  percentage  of  
    UCs  that  are  not  retained  from  one  month  to  the  next  in  a  
    given subreddit.
    (see ref paper)
    where  UCi = UCs  in  month  i  and  UCi+1  =  UCs  in  the  month  
    after month i.
    If all UCs who contributed to discourse in the first month 
    also contributed in the second month, turnover was equal to 
    0. If no UCs who contributed to discourse in the first month 
    also contributed in the second month, turnover was equal to 
    1 (M = .65;  SD = .13).
    "
    turnover <- double()
    if(is.null(df_author_prev_interval)){
      turnover <- NA
    }
    else{
      df_author_intersect <- intersect(df_author$author, df_author_prev_interval)
      turnover <- 1 - (length(df_author_intersect) / length(df_author$author))
    }
    
    df_sub <- data.frame(
                   interval=interval,
                   gini_post_dist=gini_post_dist,
                   gini_score_dist=gini_score_dist,
                   subreddit=subreddit,
                   contributors = length(unique(df_7day$author)),
                   total_posts = length(df_7day$id),
                   turnover = turnover,
                   stringsAsFactors=TRUE
                   )
    df_author_prev_interval <- df_author$author
    df_subs <- rbind(df_subs, df_sub)
  }
}

df_subs$contributors <- log(df_subs$contributors)

df_subs$is_berlin <- df_subs$subreddit == "berlin"
df_subs$is_de <- df_subs$subreddit == "de"

df_subs$interval <-as.numeric(as.character(df_subs$interval))

ggplot(df_subs, aes(x=interval, y=gini_post_dist, group = subreddit, color = subreddit)) +
  geom_point() 

ggplot(df_subs, aes(x=interval, y=gini_score_dist, group = subreddit, color = subreddit)) +
  geom_point() 

ggplot(df_subs, aes(x=interval, y=contributors, group = subreddit, color = subreddit)) +
  geom_point()

ggplot(df_subs, aes(x=interval, y=total_posts, group = subreddit, color = subreddit)) +
  geom_point()

ggplot(df_subs[!is.na(df_subs$turnover),], aes(x=interval, y=turnover, group = subreddit, color = subreddit)) +
  geom_point()

```

### Models
```{r models}
mean(df_subs$gini_post_dist)

ggplot(df_subs, aes(x=contributors, y=gini_post_dist, group = subreddit, color = subreddit)) +
  geom_point() +
  geom_smooth(method='lm', formula= y~x) +
  ylim(0,1) +
  ggtitle("UP predicting distrubition of posts per UP")

lm_model <- lm(gini_post_dist ~ contributors, data = df_subs)
summary(lm_model)

lm_model <- lm(gini_post_dist ~ contributors + interval + is_berlin + is_de , data = df_subs)
summary(lm_model)


ggplot(df_subs, aes(x=contributors, y=gini_score_dist, group = subreddit, color = subreddit)) +
  geom_point() +
  geom_smooth(method='lm', formula= y~x) +
  ylim(0,1) +
  ggtitle("UP predicting distrubition of posts score per UP")

lm_model <- lm(gini_score_dist ~ contributors, data = df_subs)
summary(lm_model)

lm_model <- lm(gini_score_dist ~ contributors + interval + is_berlin + is_de, data = df_subs)
summary(lm_model)


ggplot(df_subs[!is.na(df_subs$turnover),], aes(x=contributors, y=turnover, group = subreddit, color = subreddit)) +
  geom_point() +
  geom_smooth(method='lm', formula= y~x) +
  ylim(0,1) +
  ggtitle("UP predicting turnover")

lm_model <- lm(turnover ~ contributors, data = df_subs)
summary(lm_model)

lm_model <- lm(turnover ~ contributors + interval + is_berlin + is_de, data = df_subs)
summary(lm_model)

"
agg <- aggregate(df_with_acc$score, by=list(author=df_with_acc$author), FUN=sum)
ggplot(agg, aes(x=author, y=x)) + geom_point()
"

```

