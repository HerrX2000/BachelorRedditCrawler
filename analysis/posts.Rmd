---
title: "RedditAnalysis"
author: "Frederik Mann"
date: "29 6 2021"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Posts

```{r libs}
library(pacman)
p_load(RColorBrewer, # color pallets
       ggplot2, # reportable graphs
       cowplot, # arranges ggplot graphs nicely
       stargazer,
       MASS,
       DescTools,
       plyr) 
```

### Import data set
```{r import}
df_berlin <- read.csv("posts_berlin_2020.csv")
df_germany <- read.csv("posts_de_2020.csv")
df_europe <- read.csv("posts_europe_2020_partial.csv")
df <- rbind(df_berlin, df_germany, df_europe)
```

### Inspect
```{r inspect}
str(df)

df$over_18 <- as.logical(df$over_18)
df$locked <- as.logical(df$locked)
df$is_video <- as.logical(df$is_video)
df$is_original_content <- as.logical(df$is_original_content)
df$stickied <- as.logical(df$stickied)
df$subreddit <- as.factor(df$subreddit)

dim(df)
```

### Preprocess: Treat missing values, if applicable
```{r preprocess}
df$author_fullname[df$author_fullname == "NULL"] <- NA
df$author[df$author == ""] <- NA
nrow(df)
df <-df[!duplicated(df$id), ]
nrow(df)

# Track down variables with missing values
sum(is.na(df))
colSums(is.na(df))

# Check the percentage of missing values in the data set
(nrow(df) - nrow(na.omit(df))) / nrow(df)


df$date <- as.Date(df$datetime)



to_interval <- function(anchor.date, future.date, interval.days){
  round(as.integer(future.date - anchor.date) / interval.days, 0)
}

df$week_interval <- to_interval(as.Date('2020-01-01'), 
                          df$date, 7 )

df$month <- format(df$date, "%m")
df$month <- factor(df$month)

df <- df[!(df$stickied == TRUE),]

str(df)

```
### Data Visualisation
```{r visualisation}
data.frame(table(df$month))

dfwi <- data.frame(table(df$week_interval))
dfwi


tbl <- with(df, table(subreddit, week_interval))
ggplot(as.data.frame(tbl), aes(factor(week_interval), Freq, fill = subreddit)) +     
  geom_col(position = 'dodge')



Gini(dfwi$Freq)

nrow(df)
df_with_acc <- na.omit(df)
nrow(df_with_acc)

#df_with_acc <- df_with_acc[df_with_acc$score > 10,]

 

gini_by_7days <- data.frame(
                 interval=character(),
                 gini=double(),
                 subreddit=factor(levels = levels(df_with_acc$subreddit)),
                 stringsAsFactors=TRUE
                 )

for (subreddit in levels(df_with_acc$subreddit)){
  df_subreddit <- df_with_acc[df_with_acc$subreddit == subreddit, ]
  for (interval in unique(df_subreddit$week_interval)){
    df_7day <- df_subreddit[df_subreddit$week_interval == interval, ]
    
    df_author_posts <- count(df_7day, vars = "author")
    
    df_author_score <- aggregate(df_7day$score, by=list(author=df_7day$author), FUN=sum)
  
    
    df_author <- merge(df_author_posts, df_author_score, by="author")
    df_author$score_per_post <- df_author$x / df_author$freq
    
    gini <- Gini(df_author$score_per_post)
    gini_by_7day <- data.frame(
                   interval=interval,
                   gini=gini,
                   subreddit=subreddit,
                   stringsAsFactors=TRUE
                   )
    
    gini_by_7days <- rbind(gini_by_7days, gini_by_7day)
  }
}


gini_by_7days$interval <-as.numeric(as.character(gini_by_7days$interval))

ggplot(gini_by_7days, aes(x=interval, y=gini, group = subreddit, color = subreddit)) +
  geom_point() +
  geom_smooth(method='lm', formula= y~x) +
  ylim(0.5,1)

gini_by_months <- data.frame(
                 month=character(),
                 gini=double(), 
                 stringsAsFactors=TRUE
                 )

for (month in unique(df_with_acc$month)){
  mnth_df <- df_with_acc[df_with_acc$month == month, ]
  
  df_author_posts <- count(mnth_df, vars = "author")
  
  df_author_score <- aggregate(mnth_df$score, by=list(author=mnth_df$author), FUN=sum)

  
  df_author <- merge(df_author_posts, df_author_score, by="author")
  df_author$score_per_post <- df_author$x / df_author$freq
  
  gini <- Gini(df_author$score_per_post)
  gini_by_month <- data.frame(
                 month=month,
                 gini=gini, 
                 stringsAsFactors=TRUE
                 )
  
  gini_by_months <- rbind(gini_by_months, gini_by_month)
}

gini_by_months$month <-as.numeric(as.character(gini_by_months$month))

ggplot(gini_by_months, aes(x=month, y=gini)) +
  geom_point() +
  geom_smooth(method='lm', formula= y~x, color = "blue") +
  ylim(0,1)

agg <- aggregate(df_with_acc$score, by=list(author=df_with_acc$author), FUN=sum)
#agg
Gini(agg$x)

ggplot(agg, aes(x=author, y=x)) + geom_point()

```

